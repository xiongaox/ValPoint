name: Sync from upstream

on:
  workflow_dispatch:
  schedule:
    # 每天凌晨 3 点（UTC）尝试同步一次
    - cron: "0 3 * * *"

permissions:
  contents: write

concurrency:
  group: sync-upstream-${{ github.repository }}
  cancel-in-progress: false

env:
  # 上游仓库（你的原始仓库）。fork 后一般无需改，除非你把上游改成别的仓库。
  UPSTREAM_REPO: xiongaox/ValPoint

jobs:
  sync:
    name: Fast-forward sync default branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream "https://github.com/${UPSTREAM_REPO}.git" || true
          git remote -v

      - name: Fetch upstream
        run: |
          git fetch --prune upstream

      - name: Fast-forward merge from upstream
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          echo "Default branch: ${DEFAULT_BRANCH}"
          git checkout "${DEFAULT_BRANCH}"
          git merge --ff-only "upstream/${DEFAULT_BRANCH}"

      - name: Push back to origin
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git push origin "${DEFAULT_BRANCH}"
